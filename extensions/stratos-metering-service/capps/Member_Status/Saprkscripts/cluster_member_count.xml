<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>httpd_log_analytics</Name>
    <Script>
        CREATE TEMPORARY TABLE memberstatus
        USING CarbonAnalytics
        OPTIONS (tableName "MEMBER_LIFECYCLE");

        CREATE TEMPORARY TABLE membercount
        USING CarbonAnalytics
        OPTIONS (tableName "CLUSTER_MEMBER_COUNT",
        schema "start_time String, end_time String, cluster_id STRING, activated_instance_count INT, terminated_instance_count INT, active_instance_count INT");

        ;WITH InstanceCount as
        (select cluster_id,
        count(case when member_status='Active' and timestamp &gt; current_time(null)-60000 and
        timestamp &lt;= current_time(null) then 1 else NULL end) as activated_instance_count,
        count(case when member_status='Terminated' and timestamp &gt; current_time(null)-60000 and
        timestamp &lt;= current_time(null) then 1 else NULL end) as terminated_instance_count,
        (sum(case when member_status='Active' then 1 else 0 end) - sum(case when member_status='Terminated' then 1 else
        0 end))as active_instance_count
        from memberstatus group by cluster_id)
        INSERT INTO table membercount
        select time(current_time(null)-60000), time(current_time(null)), cluster_id, activated_instance_count,
        terminated_instance_count, active_instance_count from InstanceCount;
    </Script>
    <CronExpression>59 * * * * ?</CronExpression>
</Analytics>